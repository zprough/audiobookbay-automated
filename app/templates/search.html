{% extends "base.html" %}

{% block title %}Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
{% endblock %}

{% block content %}

<div class="title-container">
    <h1>Search AudiobookBay</h1>
</div>
<form method="post" class="search-container" onsubmit="showLoadingSpinner()">
    <input type="text" name="query" placeholder="Enter book name" class="search-bar" required>
<button type="submit" class="search-button">
    <span class="button-text">Search</span>
    <div class="button-spinner" id="button-spinner" style="display: none;">
        <div class="spinner"></div>
    </div>
</button>
</form>

<div class="message-scroller" id="message-scroller">
    <p id="scrolling-message"></p>
</div>

<div class="loading-spinner" id="loading-spinner">
    <div class="spinner"></div>
    <p>Searching...</p>
</div>

{% if error %}
  <p class="error-message">{{ error }}</p>
{% endif %}

<!-- Filter Controls -->
{% if books %}
<div class="filter-container">
    <h3>Filters</h3>
    <div class="filter-controls">
        <label class="filter-label">
            <input type="checkbox" id="englishFilter" onchange="applyFilters()">
            English Only
        </label>
        <label class="filter-label">
            <input type="checkbox" id="fullCastInclude" onchange="applyFilters()">
            Include Full Cast
        </label>
        <label class="filter-label">
            <input type="checkbox" id="fullCastExclude" onchange="applyFilters()">
            Exclude Full Cast
        </label>
        <button type="button" id="clearFilters" onclick="clearAllFilters()">Clear Filters</button>
    </div>
    <div id="filterStatus" class="filter-status"></div>
</div>
{% endif %}

<table id="resultsTable">
    <tbody>
        <!-- Results will be populated by JavaScript -->
    </tbody>
</table>

<script>
    function showLoadingSpinner() {
        const buttonSpinner = document.getElementById('button-spinner');
        buttonSpinner.style.display = 'inline-block';
        setTimeout(showScrollingMessages, 5000);
    }

    function hideLoadingSpinner() {
        const buttonSpinner = document.getElementById('button-spinner');
        const buttonText = document.querySelector('.button-text');
        buttonSpinner.style.display = 'none';
        hideScrollingMessages();
    }

    const messages = [
        "Searching... This better be worth it!",
        "Hold on, this takes a while...",
        "Still searching... Maybe grab a snack?",
        "Patience, young grasshopper...",
        "Wow, this is taking a minute!",
        "Donâ€™t worry, I got this!",
        "Maybe go for a walk?",
        "Still thinking... Almost there!",
        "Finding the best results for you!",
        "Hang tight! Searching magic happening!",
        "One moment... while I consult the ancients.",
        "Beep boop... processing... please wait...",
        "My hamsters are running on a wheel, almost there!",
        "Just gathering some pixie dust, be right back!",
        "Is it lunchtime yet? Oh, searching... right.",
        "Please remain calm, the search is in progress.",
        "Warning: Search may cause extreme awesomeness.",
        "Calculating the optimal route to your results...",
        "Almost there... just defragmenting my brain.",
        "Searching... because the internet is a big place!",
        "Polishing the search results for your viewing pleasure.",
        "The search is strong with this one.",
        "Please wait while I summon the search demons.",
        "Searching in hyperspace... almost there!",
        "My coffee is kicking in... search commencing!",
        "Just a few more gigabytes to process...",
        "Rome wasn't built in a day.",
        "Don't blame me, the internet is slow today.",
        "Almost there... just need to find the right key...",
    ];
    let messageIndex = 0;

    function showScrollingMessages() {
        const messageScroller = document.getElementById('message-scroller');
        const scrollingMessage = document.getElementById('scrolling-message');
        const shuffledMessages = messages.sort(() => Math.random() - 0.5);
        messageScroller.style.display = 'block';
        scrollingMessage.textContent = shuffledMessages[messageIndex];
        setInterval(() => {
            messageIndex = (messageIndex + 1) % messages.length;
            scrollingMessage.textContent = shuffledMessages[messageIndex];
        }, 5000);
    }

    function hideScrollingMessages() {
        const messageScroller = document.getElementById('message-scroller');
        messageScroller.style.display = 'none';
    }

    function sendToQB(link, title) {
        fetch('/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ link: link, title: title })
        }).then(response => response.json())
        .then(data => {
          alert(data.message)
          hideLoadingSpinner();
        });
    }

    // Store all books data for filtering
    let allBooks = [
        {% for book in books %}
        {
            title: "{{ book.title|e }}",
            cover: "{{ book.cover|e }}",
            link: "{{ book.link|e }}",
            language: "{{ book.language|e if book.language else '' }}",
            format: "{{ book.format|e if book.format else '' }}",
            categories: {{ book.categories|tojson if book.categories else '[]' }},
            keywords: {{ book.keywords|tojson if book.keywords else '[]' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    function applyFilters() {
        const englishFilter = document.getElementById('englishFilter').checked;
        const fullCastInclude = document.getElementById('fullCastInclude').checked;
        const fullCastExclude = document.getElementById('fullCastExclude').checked;
        
        // Prevent conflicting filters
        if (fullCastInclude && fullCastExclude) {
            if (event.target.id === 'fullCastInclude') {
                document.getElementById('fullCastExclude').checked = false;
            } else {
                document.getElementById('fullCastInclude').checked = false;
            }
        }

        let filteredBooks = allBooks.filter(book => {
            // English filter
            if (englishFilter && book.language.toLowerCase() !== 'english') {
                return false;
            }

            // Full Cast filters
            const hasFullCast = book.categories.some(cat => 
                cat.toLowerCase().includes('full cast')
            );
            
            if (fullCastInclude && !hasFullCast) {
                return false;
            }
            
            if (fullCastExclude && hasFullCast) {
                return false;
            }

            return true;
        });

        // Update the table with filtered results
        updateResultsTable(filteredBooks);
        updateFilterStatus(filteredBooks.length, allBooks.length);
    }

    function updateResultsTable(books) {
        const tbody = document.querySelector('#resultsTable tbody');
        tbody.innerHTML = '';

        books.forEach(book => {
            const row = document.createElement('tr');
            
            // Check if we're on mobile
            if (window.innerWidth <= 768) {
                // Mobile layout - single cell with card design
                const mobileCell = document.createElement('td');
                mobileCell.colSpan = 3;
                
                const mobileCard = document.createElement('div');
                mobileCard.className = 'mobile-card';
                
                // Mobile card header with cover and title
                const cardHeader = document.createElement('div');
                cardHeader.className = 'mobile-card-header';
                
                const img = document.createElement('img');
                img.src = book.cover || '/static/images/default_cover.jpg';
                img.alt = 'Book cover';
                img.className = 'mobile-cover';
                cardHeader.appendChild(img);
                
                const titleSection = document.createElement('div');
                titleSection.className = 'mobile-title-section';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'book-title';
                titleDiv.textContent = book.title;
                titleSection.appendChild(titleDiv);
                
                // Compact metadata chips for mobile
                const metaCompact = document.createElement('div');
                metaCompact.className = 'mobile-meta-compact';
                
                if (book.language) {
                    const chip = document.createElement('span');
                    chip.className = 'meta-chip';
                    chip.textContent = book.language;
                    metaCompact.appendChild(chip);
                }
                
                if (book.format) {
                    const chip = document.createElement('span');
                    chip.className = 'meta-chip';
                    chip.textContent = book.format;
                    metaCompact.appendChild(chip);
                }
                
                // Show first 2 categories only on mobile
                if (book.categories && book.categories.length > 0) {
                    const categoriesToShow = book.categories.slice(0, 2);
                    categoriesToShow.forEach(category => {
                        const chip = document.createElement('span');
                        chip.className = 'meta-chip';
                        chip.textContent = category;
                        metaCompact.appendChild(chip);
                    });
                }
                
                titleSection.appendChild(metaCompact);
                cardHeader.appendChild(titleSection);
                mobileCard.appendChild(cardHeader);
                
                // Mobile action buttons
                const mobileActions = document.createElement('div');
                mobileActions.className = 'mobile-actions';
                
                const detailsButton = document.createElement('button');
                detailsButton.textContent = 'Details';
                detailsButton.className = 'details-btn';
                detailsButton.onclick = () => window.open(book.link, '_blank');
                
                const downloadButton = document.createElement('button');
                downloadButton.textContent = 'Download';
                downloadButton.className = 'download-btn';
                downloadButton.onclick = () => sendToQB(book.link.replace(/'/g, "\\'"), book.title.replace(/'/g, "\\'"));
                
                mobileActions.appendChild(detailsButton);
                mobileActions.appendChild(downloadButton);
                mobileCard.appendChild(mobileActions);
                
                mobileCell.appendChild(mobileCard);
                row.appendChild(mobileCell);
            } else {
                // Desktop layout (original)
                row.innerHTML = `
                    <td><img src="${book.cover || '/static/images/default_cover.jpg'}" alt="Cover Art" class="cover" width="100"></td>
                    <td>
                        <div class="book-title">${book.title}</div>
                        <div class="book-metadata">
                            ${book.language ? `<div class="book-meta"><strong>Language:</strong> ${book.language}</div>` : ''}
                            ${book.format ? `<div class="book-meta"><strong>Format:</strong> ${book.format}</div>` : ''}
                            ${book.categories.length > 0 ? `<div class="book-meta"><strong>Categories:</strong> ${book.categories.join(', ')}</div>` : ''}
                            ${book.keywords.length > 0 ? `<div class="book-meta"><strong>Keywords:</strong> ${book.keywords.join(', ')}</div>` : ''}
                        </div>
                    </td>
                    <td>
                        <button onclick="window.open('${book.link}', '_blank')">Details</button>
                        <button onclick="sendToQB('${book.link.replace(/'/g, "\\'")}', '${book.title.replace(/'/g, "\\'")}')">Download to Server</button>
                    </td>
                `;
            }
            
            tbody.appendChild(row);
        });
    }

    function updateFilterStatus(filteredCount, totalCount) {
        const statusDiv = document.getElementById('filterStatus');
        if (filteredCount === totalCount) {
            statusDiv.textContent = `Showing all ${totalCount} results`;
        } else {
            statusDiv.textContent = `Showing ${filteredCount} of ${totalCount} results`;
        }
    }

    function clearAllFilters() {
        document.getElementById('englishFilter').checked = false;
        document.getElementById('fullCastInclude').checked = false;
        document.getElementById('fullCastExclude').checked = false;
        updateResultsTable(allBooks);
        updateFilterStatus(allBooks.length, allBooks.length);
    }

    // Initialize the table with all results on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (allBooks.length > 0) {
            updateResultsTable(allBooks);
            updateFilterStatus(allBooks.length, allBooks.length);
        }
    });

    // Handle window resize to update table layout
    window.addEventListener('resize', function() {
        // Debounce resize events to avoid too many updates
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(function() {
            if (allBooks.length > 0) {
                // Re-render the current filtered results
                const englishFilter = document.getElementById('englishFilter').checked;
                const fullCastInclude = document.getElementById('fullCastInclude').checked;
                const fullCastExclude = document.getElementById('fullCastExclude').checked;
                
                let filteredBooks = allBooks.filter(book => {
                    if (englishFilter && book.language.toLowerCase() !== 'english') {
                        return false;
                    }
                    
                    const hasFullCast = book.categories.some(cat => 
                        cat.toLowerCase().includes('full cast')
                    );
                    
                    if (fullCastInclude && !hasFullCast) {
                        return false;
                    }
                    
                    if (fullCastExclude && hasFullCast) {
                        return false;
                    }
                    
                    return true;
                });
                
                updateResultsTable(filteredBooks);
            }
        }, 250);
    });
</script>

{% endblock %}
